- [モジュールの説明](#モジュールの説明)
  - [環境構築モジュールの説明](#環境構築モジュールの説明)
    - [tfバックエンド](#tfバックエンド)
    - [ネットワーク](#ネットワーク)
    - [ECSクラスタ](#ecsクラスタ)
  - [サービス構築モジュールの説明](#サービス構築モジュールの説明)
    - [事前準備](#事前準備)
    - [サービスデプロイ](#サービスデプロイ)

# モジュールの説明

大きく`環境構築モジュール群`と`サービス構築モジュール群`に別れます。`環境構築モジュール群`は、主にECSサービスと付随するネットワーク環境（任意）を準備するモジュールです。プロジェクトで一度だけ実施するモジュールです。`サービス構築モジュール群`は、ソース置き場を含むECSサービスをデプロイする前準備とECSサービスのデプロイおよびCICDパイプラインを構築するモジュールです。サービスごとに実施するモジュールです。

各モジュールは`main`と`module`のディレクトリに分かれて構成されます。`main`は各モジュールのパラメータを指定する`{モジュール名}.tf`という名前のtfファイルを格納しています。基本的に利用者はこのmain配下のtfファイル内にあるlocalsの値のみ修正し実行します。`module`は各モジュールが実行するサブモジュール群です。基本的に利用者はmodule配下を気にする必要はありません。（追加の設定など細かなカスタマイズが必要な方や実装が気になる方は見てください。）

また、各モジュールを実行した後に作成されるtfstateはリモートのバックエンドへ保存します。バックエンドはS3バケットとDynamoDBで構成されます。tfstateはS3バケットに保存されます。tfstateへの書き込みはDynamoDBで排他制御を行います。バックエンドにtfstateを保存することで複数人での環境の共有やモジュール間のパラメータ連携が可能になります。

## 環境構築モジュールの説明

基本となる以下環境をセットアップするterraformモジュールを用意しています。

- tfバックエンド
- ネットワーク
- ECSクラスタ

### tfバックエンド

`tfバックエンド`は各モジュール実行後に作成されるtfstateファイルを保存するS3バケットとDynamoDBを構築するterraformモジュールです。以降のモジュールはすべてこのモジュールで作成したバックエンドを使用します。これにより、モジュール間でパラメータ（VPC IDなど）を連携させています。なお、このモジュール自体のtfstateファイルはリモートに保存されず、モジュールを実行した端末のローカルディスク（実行時のカレントディレクトリ）に保存されます。そのため、このモジュールのtfstateファイルについては慎重に管理してください。

### ネットワーク

`ネットワーク`はVPCとパブリックサブネットおよびプライベートサブネットを構築するterraformモジュールです。インターネットゲートウェイやNATゲートウェイ、ECRへのエンドポイントも構築します。このモジュールで作成した`VPCのID`や`サブネットのID`は他のモジュールでも使用します。このモジュールはVPCがない場合などに実行ください。すでにVPCやサブネットがある場合はそれらのIDを他モジュールで使用してください。

### ECSクラスタ

`ECSクラスタ`はECSのサービスをまとめるクラスタを構築するモジュールです。また、ECSタスクやCodePipeline、CodeBuild、CodeDeployに必要となる共通のIAMポリシーおよびロールを作成します。

## サービス構築モジュールの説明

ECSサービスとサービスのCICDをセットアップするモジュールを用意しています。大きく以下の2つがあります。

- 事前準備
- サービスデプロイ

### 事前準備

`事前準備`はサービスをデプロイする前のソース置き場を構築するモジュールです。アプリケーションソース、デプロイ設定を格納するCodeCommitレポジトリをそれぞれ構築し、コンテナイメージを格納するECRレポジトリも構築します。また、サービスに付与するセキュリティグループも作成します。ECRレポジトリは一日以上経過しているタグのついていないイメージを削除するライフサイクルポリシーも設定します。

### サービスデプロイ

`サービスデプロイ`はサービスのパイプライン構築およびCICDの設定を行うモジュールです。ECSサービスに紐づくALBもデプロイします。CodePipelineのアクションとしてコンテナをビルドするCodeBuild、ECSサービスのBlue/Greenデプロイを設定するCodeDeployを構築します。このモジュールを実行する前に事前準備モジュールで作成したソース置き場にアプリケーションソースおよびデプロイ設定を格納してください。CICDはソース置き場の情報が更新される度に自動で実行されます。
